#!/usr/bin/env bash
set -eo pipefail

# $0 NAME #optional CONFIGSTYLE FORCEPUBKEY
if [ "$#" -ne 1 ]; then
    echo "Illegal number of parameters"
fi

CLIENTS_DIR="${CLIENTS_DIR:-network/clients}"
curr_client_dir="${CLIENTS_DIR}/${1}"

if [ -e "$curr_client_dir" ]; then
    echo "Client '$1' already exists."
    exit 1
fi

WG_TRANSPORTER_KEY_FILE="${WG_TRANSPORTER_KEY_FILE:-network/secrets/wg-transporter}"

ip="$(./bin/free-transporter-ips "$CLIENTS_DIR" | sort -n -t . -k 1,1 -k 2,2 -k 3,3 -k 4,4 | head -n1)/32"
privkey="$(wg genkey)"

cat <<EOF
[Interface]
Address = ${ip}/32
PrivateKey = ${privkey}

[Peer]
PublicKey = $(wg pubkey < "${WG_TRANSPORTER_KEY_FILE}")
AllowedIPs = 10.42.0.0/24
Endpoint = federation.space:$(< network/federation/port)
PersistentKeepalive = 25
EOF

# read -p "Press enter to continue"
./bin/add-client "$curr_client_dir" "$ip" "$(echo "$privkey" | wg pubkey)"
